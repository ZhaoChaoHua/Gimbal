#include "serial_com.h"

void SerialManager::update()
{
	
}

void SerialManager::start_init()
{
	rt_err_t ret = RT_EOK;
	rdevice = rt_device_find(wd_name);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
	wdevice = rt_device_find(rd_name);
	
	/* 设置回调函数并打开设备 */
    ret = rt_device_open(rdevice,RT_DEVICE_OFLAG_RDWR | RT_DEVICE_FLAG_INT_RX);
	if(ret != RT_EOK)
		rt_kprintf("[init]Read Device open fail.\n");
	ret = rt_device_open(wdevice,RT_DEVICE_OFLAG_RDWR | RT_DEVICE_FLAG_INT_RX);
	if(ret != RT_EOK)
		rt_kprintf("[init]Write Device open fail.\n");
}

// Convert a Mavlink msg to a buffer[] to send
rt_size_t SerialManager::mavlink2serial(Mavlink_msg_t *msg, uint8_t *buf)
{
	rt_size_t len;
	uint8_t i;
	len = (rt_size_t)(msg->payload_lth+8);
	buf[0] = msg->stx;
	buf[1] = msg->payload_lth;
	buf[2] = msg->packet_seq;
	buf[3] = msg->sys_id;
	buf[4] = msg->comp_id;
	buf[5] = msg->msg_id;
	for(i = 0; i < msg->payload_lth; i++)
	{
		buf[6+i] = msg->data[i];
	}
	buf[len-2] = msg->crcl;
	buf[len-1] = msg->crch;
	return len;
}

// Send a mavlink msg from serial
rt_size_t SerialManager::send_mavlink(Mavlink_msg_t *msg)
{
	uint8_t buf[MAX_MAV_LENTH];
	rt_size_t len;
	len = mavlink2serial(msg,buf);
	return rt_device_write(wdevice,0,buf,len);
}

// Convert a buffer to Mavlink msg
void SerialManager::serial2mavlink(Mavlink_msg_t *msg)
{
	rt_size_t len;
	uint8_t buf;
	len = rt_device_read(rdevice,0,&buf,1);
	if(len > 0)
	{
		switch(mavlink_xbee_rx_sta)
		{
			case MAVLINK_XBEE_RX_STOP:
				if(buf == 0xFE)
				{
					mavlink_xbee_rx_sta = MAVLINK_XBEE_RX_STX;
					msg->stx = buf;
				}
				break;
			case MAVLINK_XBEE_RX_STX:
				mavlink_xbee_rx_sta = MAVLINK_XBEE_RX_PLTH;
			  msg->payload_lth = buf;
			  break;
			case MAVLINK_XBEE_RX_PLTH:
				mavlink_xbee_rx_sta = MAVLINK_XBEE_RX_PSEQ;
			  msg->packet_seq = buf;
			  break;
			case MAVLINK_XBEE_RX_PSEQ:
				mavlink_xbee_rx_sta = MAVLINK_XBEE_RX_SYSID;
			  msg->sys_id = buf;
			  break;
			case MAVLINK_XBEE_RX_SYSID:
				mavlink_xbee_rx_sta = MAVLINK_XBEE_RX_COMPID;
			  msg->comp_id = buf;
			  break;
			case MAVLINK_XBEE_RX_COMPID:
				mavlink_xbee_rx_sta = MAVLINK_XBEE_RX_MSGID;
			  msg->msg_id = buf;
			  break;
			case MAVLINK_XBEE_RX_MSGID:
				msg->data[mavlink_xbee_rx_data_num] = buf;
			  mavlink_xbee_rx_data_num++;
			  if(mavlink_xbee_rx_data_num == msg->payload_lth)
				{
					mavlink_xbee_rx_data_num = 0;
					mavlink_xbee_rx_sta = MAVLINK_XBEE_RX_DATA;
				}
				break;
			case MAVLINK_XBEE_RX_DATA:
				mavlink_xbee_rx_sta = MAVLINK_XBEE_RX_CRCL;
			  msg->crcl = buf;
			  break;
			case MAVLINK_XBEE_RX_CRCL:
				mavlink_xbee_rx_sta = MAVLINK_XBEE_RX_CRCH;
			  msg->crch = buf;
			  mavlink_xbee_rx_sta = MAVLINK_XBEE_RX_STOP;
			  data_rx_ready = true;
			  break;
			default:
				break;
		}
	}
}
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
